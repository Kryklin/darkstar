<mat-card class="encrypt-card">
  @if (!showResult) {
    <mat-card-header>
      <mat-card-title>{{ protocolTitle }}</mat-card-title>
      <mat-card-subtitle>{{ protocolSummary }}</mat-card-subtitle>
      <a mat-button color="accent" [href]="protocolLink" target="_blank" class="learn-more-btn"> Learn More <mat-icon>open_in_new</mat-icon> </a>
    </mat-card-header>
    <mat-card-content>
      <mat-stepper linear #stepper>
        <mat-step [stepControl]="firstFormGroup">
          <form [formGroup]="firstFormGroup">
            <ng-template matStepLabel>Enter Recovery Phrase</ng-template>
            <mat-form-field class="full-width">
              <mat-label>Insert the SLIP39 seed phrase</mat-label>
              <textarea matInput formControlName="firstCtrl" cdkTextareaAutosize #autosize="cdkTextareaAutosize" cdkAutosizeMinRows="4" placeholder="e.g. word1 word2 word3 ..."></textarea>
            </mat-form-field>
            <div class="stepper-buttons">
              <button mat-button (click)="generateRandomWords()">Generate Random Words</button>
              <button mat-button matStepperNext>Next</button>
            </div>
          </form>
        </mat-step>
        <mat-step [stepControl]="secondFormGroup">
          <form [formGroup]="secondFormGroup">
            <ng-template matStepLabel>Set Password</ng-template>
            <mat-form-field class="full-width">
              <mat-label>Encryption password</mat-label>
              <input matInput formControlName="secondCtrl" type="password" required />
            </mat-form-field>
            <div class="stepper-buttons">
              <button mat-button matStepperPrevious>Back</button>
              <button mat-raised-button color="primary" (click)="onSubmit()">Submit</button>
            </div>
          </form>
        </mat-step>
      </mat-stepper>
    </mat-card-content>
    <mat-card-footer>
      <p class="footer-text">Encryption is performed locally on your device. Your private data is never transmitted.</p>
    </mat-card-footer>
  } @else {
    <mat-card-header>
      <mat-card-title>Encryption Successful</mat-card-title>
      <mat-card-subtitle>Your data has been securely encrypted.</mat-card-subtitle>
    </mat-card-header>
    <mat-card-content>
      <mat-form-field class="full-width">
        <mat-label>Encrypted Data</mat-label>
        <textarea matInput readonly [value]="encryptedData" rows="8"></textarea>
        <button mat-icon-button matSuffix (click)="copyToClipboard(encryptedData)" matTooltip="Copy Encrypted Data">
          <mat-icon>content_copy</mat-icon>
        </button>
      </mat-form-field>
      <mat-form-field class="full-width">
        <mat-label>Reverse Key</mat-label>
        <textarea matInput readonly [value]="reverseKey" rows="2"></textarea>
        <button mat-icon-button matSuffix (click)="copyToClipboard(reverseKey)" matTooltip="Copy Reverse Key">
          <mat-icon>content_copy</mat-icon>
        </button>
      </mat-form-field>

      <mat-divider></mat-divider>

      <div class="stealth-export-section">
        <h3>Stealth Export</h3>
        <p class="hint-text">Disguise your encrypted data as a common system file.</p>

        <div class="export-controls">
          <mat-form-field appearance="outline">
            <mat-label>Export Format</mat-label>
            <mat-select [(value)]="stealthMode">
              @for (mode of stealthModes; track mode) {
                <mat-option [value]="mode.value">{{ mode.label }}</mat-option>
              }
            </mat-select>
          </mat-form-field>

          @if (stealthMode !== 'standard') {
            <div class="slider-container">
              <span class="label">Noise Level: {{ stealthNoiseLevel * 100 }}%</span>
              <mat-slider min="0.1" max="1.0" step="0.1" showTickMarks>
                <input matSliderThumb [(ngModel)]="stealthNoiseLevel" />
              </mat-slider>
            </div>
          }
        </div>

        <button mat-flat-button color="accent" (click)="downloadFile()"><mat-icon>download</mat-icon> Download {{ stealthMode === 'standard' ? 'Text' : 'File' }}</button>
      </div>
    </mat-card-content>
    <mat-card-actions class="result-actions">
      <button mat-button (click)="reset()">Reset</button>
    </mat-card-actions>
    <mat-card-footer>
      <p class="footer-text">Store both the encrypted data and the reverse key securely. You will need both to decrypt your data.</p>
    </mat-card-footer>
  }
</mat-card>
