<div class="settings-container">
  <h1>Settings</h1>

  <section class="settings-section">
    <h2>Appearance</h2>
    <mat-divider></mat-divider>

    <div class="setting-row">
      <div class="setting-label">
        <span class="title">Color Theme</span>
        <span class="description">Select the accent color for the application</span>
      </div>
      <mat-form-field appearance="outline">
        <mat-label>Select Theme</mat-label>
        <mat-select [value]="theme.selectedTheme()" (selectionChange)="theme.setTheme($event.value)" [compareWith]="compareThemes">
          <mat-select-trigger>
            <div class="theme-option">
              <span class="color-dot" [style.background-color]="theme.selectedTheme().primary"></span>
              {{ theme.selectedTheme().name }}
            </div>
          </mat-select-trigger>
          @for (t of theme.availableThemes; track t.name) {
            <mat-option [value]="t">
              <div class="theme-option">
                <span class="color-dot" [style.background-color]="t.primary"></span>
                {{ t.name }}
              </div>
            </mat-option>
          }
        </mat-select>
      </mat-form-field>
    </div>
  </section>


  <section class="settings-section">
    <h2>System</h2>
    <mat-divider></mat-divider>

    @if (isWindows) {
      <div class="setting-row">
        <div class="setting-label">
          <span class="title">Shortcuts</span>
          <span class="description">Create desktop and start menu shortcuts</span>
        </div>
        <div class="button-group">
          <button mat-stroked-button (click)="createShortcut('desktop')">Desktop Shortcut</button>
          <button mat-stroked-button (click)="createShortcut('start-menu')">Start Menu Shortcut</button>
        </div>
      </div>
    }

    @if (isElectron) {

      <div class="setting-row">
        <div class="setting-label">
          <span class="title">Version Locking</span>
          <span class="description">Prevent automatic updates and stay on the current version</span>
        </div>
        <mat-slide-toggle [checked]="updateService.versionLocked()" (change)="updateService.toggleVersionLock()" color="warn"> </mat-slide-toggle>
      </div>
    }

    <div class="setting-row">
      <div class="setting-label">
        <span class="title">Reset Vault</span>
        <span class="description">Delete all encrypted notes and reset the vault</span>
      </div>
      <button mat-stroked-button color="warn" (click)="resetVault()">Reset Vault</button>
    </div>

    <div class="setting-row">
      <div class="setting-label">
        <span class="title">Reset Application</span>
        <span class="description">Clear all data and restart</span>
      </div>
      <button mat-flat-button color="warn" (click)="resetApp()">Reset App</button>
    </div>
  </section>

  <section class="settings-section">
    <h2>Security</h2>
    <mat-divider></mat-divider>

    <div class="setting-row">
      <div class="setting-label">
        <span class="title">Duress / Panic Mode</span>
        <span class="description">
          Set a specific password that will <strong>permanently destroy</strong> your vault if entered incorrectly. Use this if forced to unlock under threat.
        </span>
      </div>
      
      <div class="duress-controls" style="display: flex; gap: 10px; align-items: center;">
        @if (duressService.isDuressConfigured()) {
          <span class="status-badge warn">Active</span>
          <button mat-stroked-button color="warn" (click)="clearDuress()">Disable</button>
        } @else {
          <mat-form-field subscriptSizing="dynamic">
            <mat-label>Panic Password</mat-label>
            <input matInput type="password" [(ngModel)]="duressPassword">
          </mat-form-field>
          <button mat-flat-button color="warn" [disabled]="!duressPassword" (click)="setDuress()">Set</button>
        }
      </div>
    </div>

    <div class="setting-row">
      <div class="setting-label">
        <span class="title">Automated Backups</span>
        <span class="description">Configure scheduled exports of your vault data</span>
        @if (isElectron && resolvedBackupPath) {
          <span class="path-info" style="font-size: 0.8em; opacity: 0.7; font-family: monospace; display: block; margin-top: 4px;">
            Target: {{ resolvedBackupPath }}
          </span>
        }
      </div>
      <button mat-flat-button color="primary" (click)="openBackupConfig()">Configure</button>
    </div>

    @if (isElectron) {
      <div class="setting-row">
        <div class="setting-label">
          <span class="title">Restore from Backup</span>
          <span class="description">Select a previous backup file to restore your vault</span>
        </div>
        <button mat-flat-button color="warn" (click)="restoreBackup()">Restore</button>
      </div>
    }

    <div class="setting-row">
      <div class="setting-label">
        <span class="title">Two-Factor Authentication (TOTP)</span>
        <span class="description">Require an authenticator app code to unlock your vault</span>
      </div>
      <div class="duress-controls">
         @if (isTotpEnabled) {
             <span class="status-badge success" style="color: #4caf50; border: 1px solid #4caf50; padding: 2px 8px; border-radius: 4px; margin-right: 10px;">Enabled</span>
             <button mat-stroked-button color="warn" (click)="toggleTotp()">Disable</button>
         } @else {
             <button mat-flat-button color="primary" (click)="toggleTotp()">Set Up 2FA</button>
         }
      </div>
    </div>

    <div class="setting-row">
      <div class="setting-label">
        <span class="title">{{ authName }}</span>
        <span class="description">Use {{ authName }} to unlock your vault</span>
      </div>
      <div class="duress-controls">
         @if (isBiometricEnabled) {
             <span class="status-badge success" style="color: #4caf50; border: 1px solid #4caf50; padding: 2px 8px; border-radius: 4px; margin-right: 10px;">Enabled</span>
             <button mat-stroked-button color="warn" (click)="toggleBiometrics()">Disable</button>
         } @else {
             <button mat-flat-button color="primary" [disabled]="isRegisteringBiometrics" (click)="toggleBiometrics()">
                @if (!isRegisteringBiometrics) {
                    <span>Enable {{ authName }}</span>
                }
                @if (isRegisteringBiometrics) {
                    <mat-spinner diameter="20"></mat-spinner>
                }
             </button>
         }
      </div>
    </div>

    <div class="setting-row">
      <div class="setting-label">
        <span class="title">Hardware Security Key</span>
        <span class="description">Use a YubiKey or FIDO2 device to unlock your vault</span>
      </div>
      <div class="duress-controls">
         @if (isHardwareKeyEnabled) {
             <span class="status-badge success" style="color: #4caf50; border: 1px solid #4caf50; padding: 2px 8px; border-radius: 4px; margin-right: 10px;">Linked</span>
             <button mat-stroked-button color="warn" (click)="toggleHardwareKey()">Unlink</button>
         } @else {
             <button mat-flat-button color="primary" [disabled]="isRegisteringHardwareKey" (click)="toggleHardwareKey()">
                @if (!isRegisteringHardwareKey) {
                    <span>Register YubiKey</span>
                }
                @if (isRegisteringHardwareKey) {
                    <mat-spinner diameter="20"></mat-spinner>
                }
             </button>
         }
      </div>
    </div>
  </section>
</div>
