<div class="vault-auth-container">
  <div class="auth-card">
    <div class="lock-icon">
      <mat-icon>{{ requiresTotp ? 'dialpad' : 'lock' }}</mat-icon>
    </div>

    <h2>{{ requiresTotp ? 'Two-Factor Authentication' : (hasVault() ? 'Unlock Vault' : 'Create Vault') }}</h2>
    <p class="subtitle">
      {{ requiresTotp ? 'Enter the code from your Authenticator app.' : (hasVault() ? 'Enter your master password to decrypt your notes.' : 'Set a strong master password. This cannot be recovered if lost.') }}
    </p>

    @if (!requiresTotp) {
      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Master Password</mat-label>
        <input matInput [type]="hidePassword ? 'password' : 'text'" [(ngModel)]="password" (keyup.enter)="submit()" />
        <button mat-icon-button matSuffix (click)="hidePassword = !hidePassword">
          <mat-icon>{{ hidePassword ? 'visibility_off' : 'visibility' }}</mat-icon>
        </button>
      </mat-form-field>

      @if (!hasVault()) {
        <app-entropy-meter [value]="password"></app-entropy-meter>
      }

      @if (!hardwareLoading && !biometricsLoading) {
          <div class="actions">
            <button mat-flat-button color="primary" [disabled]="loading || !password" (click)="submit()">
              @if (!passwordLoading) {
                <span>{{ hasVault() ? 'Unlock' : 'Create Vault' }}</span>
              }
              @if (passwordLoading) {
                <mat-spinner diameter="20"></mat-spinner>
              }
            </button>
          </div>
      }

      @if (hasVault() && (isHardwareKeyEnabled || isBiometricEnabled)) {
          <div class="actions alt-auth-actions" style="margin-top: 10px; justify-content: center; gap: 10px;">
             @if (isHardwareKeyEnabled) {
                 <button mat-stroked-button (click)="submitHardwareKey()" [disabled]="loading">
                     @if (!hardwareLoading) {
                         <mat-icon>usb</mat-icon>
                     }
                     @if (!hardwareLoading) {
                         <span>Use Hardware Key</span>
                     }
                     @if (hardwareLoading) {
                         <mat-spinner diameter="20"></mat-spinner>
                     }
                 </button>
             }
             @if (isBiometricEnabled) {
                 <button mat-stroked-button (click)="submitBiometrics()" [disabled]="loading">
                     @if (!biometricsLoading) {
                         <mat-icon>fingerprint</mat-icon>
                     }
                     @if (!biometricsLoading) {
                         <span>{{ isWindows ? 'Windows Hello' : 'Touch ID' }}</span>
                     }
                     @if (biometricsLoading) {
                         <mat-spinner diameter="20"></mat-spinner>
                     }
                 </button>
             }
          </div>
      }
    } @else {
      <!-- TOTP Entry -->
      <mat-form-field appearance="outline" class="full-width">
        <mat-label>Authenticator Code</mat-label>
        <input matInput type="text" [(ngModel)]="totpCode" placeholder="123456" maxlength="6" (keyup.enter)="submitTotp()" />
      </mat-form-field>
      
      <div class="actions">
          <button mat-button (click)="requiresTotp = false; vaultService.lock();">Cancel</button>
          <button mat-flat-button color="primary" [disabled]="loading || totpCode.length < 6" (click)="submitTotp()">
            @if (!loading) {
              <span>Verify</span>
            }
            @if (loading) {
              <mat-spinner diameter="20"></mat-spinner>
            }
          </button>
      </div>
    }

    @if (vaultService.error()) {
      <p class="error-msg">
        {{ vaultService.error() }}
      </p>
    }

    @if (!hasVault()) {
      <div class="warning"><mat-icon inline>warning</mat-icon> Zero-Knowledge Encryption: We do not store your password.</div>
    }
  </div>
</div>
