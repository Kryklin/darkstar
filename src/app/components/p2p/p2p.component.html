<div class="p2p-container">

  <header>
    <h1><mat-icon>security</mat-icon> Peer-to-Peer Messaging</h1>
    <!-- <p>Secure, anonymous communication via the Tor Network.</p> -->
    <p>Decentralized. Anonymous. Uncensored.</p>
  </header>

  <div class="glass-card status-card" [ngClass]="p2pService.status()">
    <h2>
      Network Status
      <div class="status-indicator" [ngClass]="p2pService.status()">
        <div class="indicator-dot"></div>
        <span>{{ p2pService.status() | titlecase }}</span>
      </div>
    </h2>
    
    <div class="card-content">
      @if (p2pService.status() === 'offline') {
        <div class="action-area">
          <p>Connect to the Tor network to generate your anonymous identity.</p>
          <div class="actions">
              <button mat-flat-button color="primary" (click)="goOnline()">
              <mat-icon>public</mat-icon> GO ONLINE
              </button>
          </div>
        </div>
      }

      @if (p2pService.status() === 'connecting') {
        <div class="action-area">
          <div style="display: flex; gap: 15px; align-items: center; flex-direction: column; width: 100%;">
              <div style="display: flex; gap: 10px; align-items: center;">
                  <mat-spinner diameter="30"></mat-spinner>
                  <p style="margin: 0">Establishing Tor Circuit... {{ p2pService.bootstrapProgress().progress }}%</p>
              </div>
              <mat-progress-bar mode="determinate" [value]="p2pService.bootstrapProgress().progress" style="width: 100%; max-width: 300px;"></mat-progress-bar>
              <small style="color: var(--text-secondary); font-size: 0.8em;">{{ p2pService.bootstrapProgress().summary }}</small>
          </div>
        </div>
      }

      @if (p2pService.status() === 'online') {
        <div class="action-area online-area">
          <p>Your Hidden Service Address:</p>
          <div class="onion-box">
            <mat-icon>vpn_key</mat-icon>
            <code>{{ p2pService.onionAddress() }}</code>
            <button mat-icon-button (click)="copyAddress()" matTooltip="Copy Address">
              <mat-icon>content_copy</mat-icon>
            </button>
          </div>
          <div class="actions" style="margin-top: 15px;">
             <button mat-stroked-button color="warn" (click)="goOffline()">
                <mat-icon>power_settings_new</mat-icon> GO OFFLINE
             </button>
          </div>
        </div>
      }
    </div>
  </div>


  <div class="glass-card messaging-area" [class.disabled-area]="p2pService.status() !== 'online'">
      <div class="contacts-panel">
          <h3>Contacts</h3>
          <div class="add-contact">
              <input type="text" placeholder="Paste .onion address..." [(ngModel)]="newContact" (keydown.enter)="addContact()" [disabled]="p2pService.status() !== 'online'">
              <button mat-icon-button (click)="addContact()" [disabled]="p2pService.status() !== 'online'">
                  <mat-icon>person_add</mat-icon>
              </button>
          </div>
          <div class="contacts-list">
              @for (contact of p2pService.contacts(); track contact.onionAddress) {
                  <div class="contact-item" [class.active]="true">
                      <div class="status-dot" [ngClass]="contact.status" [matTooltip]="'Status: ' + contact.status"></div>
                      <span class="onion-short">{{ contact.onionAddress.substring(0, 16) }}...</span>
                      <div class="contact-actions">
                        <button mat-icon-button class="mini-btn" (click)="checkContactStatus(contact); $event.stopPropagation()" [disabled]="p2pService.status() !== 'online'">
                            <mat-icon style="font-size: 16px; width: 16px; height: 16px;">refresh</mat-icon>
                        </button>
                        <button mat-icon-button class="mini-btn delete-btn" color="warn" (click)="deleteContact(contact); $event.stopPropagation()">
                            <mat-icon style="font-size: 16px; width: 16px; height: 16px;">delete</mat-icon>
                        </button>
                      </div>
                  </div>
              }
              @if (p2pService.contacts().length === 0) {
                  <div class="empty-contacts">No contacts added.</div>
              }
          </div>
      </div>
      
      <div class="chat-panel">
          @if (isSending) {
            <div class="network-animation-overlay">
              <div class="network-path">
                <div class="node sender">
                  <mat-icon>computer</mat-icon>
                  <span>YOU</span>
                </div>
                <div class="connection-line">
                  <div class="packet"></div>
                </div>
                <div class="node relay">
                  <mat-icon>router</mat-icon>
                  <span>ENTRY</span>
                </div>
                <div class="connection-line">
                  <div class="packet delay-1"></div>
                </div>
                <div class="node relay">
                  <mat-icon>cloud_queue</mat-icon>
                  <span>RELAY</span>
                </div>
                <div class="connection-line">
                  <div class="packet delay-2"></div>
                </div>
                <div class="node relay">
                  <mat-icon>router</mat-icon>
                  <span>EXIT</span>
                </div>
                <div class="connection-line">
                  <div class="packet delay-3"></div>
                </div>
                <div class="node recipient">
                  <mat-icon>person</mat-icon>
                  <span>PEER</span>
                </div>
              </div>
              <div class="status-text">Encrypting & Routing through Tor Network...</div>
            </div>
          }

          @if (p2pService.contacts().length > 0) {
              <div class="chat-window">
                  @for (msg of p2pService.messages(); track msg.id) {
                      <div class="message-bubble" [class.self]="msg.isSelf">
                          <div class="message-content">
                              <div class="sender-name">
                                  {{ msg.sender.substring(0,8) }}...
                                  @if (msg.verified) {
                                      <mat-icon style="font-size: 14px; height: 14px; width: 14px; vertical-align: middle; color: #4caf50;" title="Verified Signature">verified</mat-icon>
                                  } @else if (!msg.isSelf && msg.signature) {
                                      <mat-icon style="font-size: 14px; height: 14px; width: 14px; vertical-align: middle; color: #f44336;" title="Invalid Signature">gpp_bad</mat-icon>
                                  }
                              </div>
                              <div class="text">{{ msg.content }}</div>
                              <div class="time">{{ msg.timestamp | date:'shortTime' }}</div>
                          </div>
                      </div>
                  }
              </div>
              <div class="chat-input">
                  <!-- Disable if I am offline OR if the peer is offline/unknown -->
                  <input type="text" 
                         [placeholder]="(p2pService.status() !== 'online') ? 'You are offline' : (p2pService.contacts()[0].status !== 'online' ? 'Peer is offline or unknown' : 'Type a message...')"
                         [(ngModel)]="newMessage" 
                         (keydown.enter)="sendMessage(p2pService.contacts()[0])"
                         [disabled]="p2pService.status() !== 'online' || p2pService.contacts()[0].status !== 'online'">
                  
                  <button mat-icon-button 
                          (click)="sendMessage(p2pService.contacts()[0])" 
                          [disabled]="p2pService.status() !== 'online' || p2pService.contacts()[0].status !== 'online'">
                      <mat-icon>send</mat-icon>
                  </button>
              </div>
          } @else {
              <div class="no-chat-selected">
                  <mat-icon>forum</mat-icon>
                  <p>Add a contact to start messaging.</p>
              </div>
          }
      </div>
  </div>



